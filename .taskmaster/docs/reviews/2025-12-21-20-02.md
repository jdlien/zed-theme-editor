# Code Review (2025-12-21 20:02)

## High-risk / likely bugs
- `updateColorAtPath` splits paths on `.` so keys like `"editor.background"` and `"comment.doc"` cannot be updated; most Zed theme keys will fail to update. `src/lib/jsonParsing.ts`
- `extractColors` skips color arrays like `accents` (and any future color arrays other than `players`), so those colors never surface in the UI. `src/lib/jsonParsing.ts`
- `hasUnsavedChanges` is set to `true` on undo/redo and never clears when undoing back to the original state, so the unsaved indicator can be wrong. `src/hooks/useThemeEditor.tsx`

## Architectural gaps / PRD alignment
- `useThemeEditor` treats the parsed `ThemeFamily` as canonical state and implements its own history. The PRD now expects CodeMirror’s document to be the source of truth and CodeMirror history to handle undo/redo, which will likely require a refactor to avoid duplicated state and desync. `src/hooks/useThemeEditor.tsx`
- `originalText` currently stores normalized JSON rather than the raw file. If a “revert to original” feature is added, the raw text should be stored separately. `src/hooks/useThemeEditor.tsx`

## Refactors / improvements
- Replace dot-splitting paths with a path representation that preserves literal keys with dots (e.g., JSON Pointer with escaping, or an array of path segments emitted by `extractColors`). Update `extractColors` and `updateColorAtPath` together. `src/lib/jsonParsing.ts`
- `useLocalStorage` manually dispatches a `StorageEvent`, which isn’t guaranteed to be constructible or meaningful in all browsers and is redundant for same-tab state updates. Consider removing or guarding it. `src/hooks/useLocalStorage.ts`
- `DropZone` includes an `invalid` drag state but never sets it; implement invalid-type feedback or remove the unused state. `src/components/DropZone.tsx`
- Validation in `parseThemeFile` requires `author` to be a string. Some theme files may omit `author`, which would be falsely rejected. Align with the schema’s required fields. `src/lib/jsonParsing.ts`
- File picker filters only include `application/json` for `.json5`; some platforms might not show `.json5` under this MIME. Consider relying on extensions alone or adding broader accepts. `src/hooks/useFileAccess.ts`

## Test gaps
- Add tests for dotted keys and syntax keys in `extractColors`/`updateColorAtPath` (`style['editor.background']`, `style.syntax['comment.doc']`). `src/lib/jsonParsing.ts`
- Add a test that verifies `hasUnsavedChanges` becomes `false` after undoing back to the initial state. `src/hooks/useThemeEditor.tsx`
